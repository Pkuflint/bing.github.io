<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>理解KVO - 用Swift在WKWebView中添加进度条 - 小兵的诗篇</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Shen Xiaobing" />
  <meta name="description" content="KVO，即Key-value observation，是苹果提供的一种机制，它可以使监听对象在被监听对象的数值发生改变时收到通知，进而去进行响应的处理。
" />

  <meta name="keywords" content="小兵哥, 个人博客, pkuflint, 火石" />






<meta name="generator" content="Hugo 0.62.2" />


<link rel="canonical" href="http://shenxiaobing.com/post/2019/understanding-kvo-in-swift/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.0995afa14b62cd93e93cfc066b646c4c17a3eddca0e9d52a1d9dcf5d90aaacd3.css" integrity="sha256-CZWvoUtizZPpPPwGa2RsTBej7dyg6dUqHZ3PXZCqrNM=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="理解KVO - 用Swift在WKWebView中添加进度条" />
<meta property="og:description" content="KVO，即Key-value observation，是苹果提供的一种机制，它可以使监听对象在被监听对象的数值发生改变时收到通知，进而去进行响应的处理。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://shenxiaobing.com/post/2019/understanding-kvo-in-swift/" />
<meta property="article:published_time" content="2018-06-28T05:40:11+08:00" />
<meta property="article:modified_time" content="2018-06-28T05:40:11+08:00" />
<meta itemprop="name" content="理解KVO - 用Swift在WKWebView中添加进度条">
<meta itemprop="description" content="KVO，即Key-value observation，是苹果提供的一种机制，它可以使监听对象在被监听对象的数值发生改变时收到通知，进而去进行响应的处理。">
<meta itemprop="datePublished" content="2018-06-28T05:40:11&#43;08:00" />
<meta itemprop="dateModified" content="2018-06-28T05:40:11&#43;08:00" />
<meta itemprop="wordCount" content="2866">



<meta itemprop="keywords" content="KVO,Swift," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="理解KVO - 用Swift在WKWebView中添加进度条"/>
<meta name="twitter:description" content="KVO，即Key-value observation，是苹果提供的一种机制，它可以使监听对象在被监听对象的数值发生改变时收到通知，进而去进行响应的处理。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42920896-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">小兵的诗篇</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/categories/%E7%94%9F%E6%B4%BB/">生活</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/categories/%E8%AF%BB%E4%B9%A6/">读书</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/categories/%E7%BC%96%E7%A8%8B/">编程</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="http://shenxiaobing.com">
              全部
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="http://shenxiaobing.com/post/">全部文章</a>
              </li>
            
              <li>
                <a href="http://shenxiaobing.com/categories/">分类</a>
              </li>
            
              <li>
                <a href="http://shenxiaobing.com/tags/">标签</a>
              </li>
            
              <li>
                <a href="http://shenxiaobing.com/about">关于</a>
              </li>
            
          </ul>
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      小兵的诗篇
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/categories/%E7%94%9F%E6%B4%BB/">生活</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/categories/%E8%AF%BB%E4%B9%A6/">读书</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://shenxiaobing.com/categories/%E7%BC%96%E7%A8%8B/">编程</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          <a class="menu-item-link menu-parent" href="http://shenxiaobing.com">全部</a>
          <ul class="submenu">
            
              <li>
                <a href="http://shenxiaobing.com/post/">全部文章</a>
              </li>
            
              <li>
                <a href="http://shenxiaobing.com/categories/">分类</a>
              </li>
            
              <li>
                <a href="http://shenxiaobing.com/tags/">标签</a>
              </li>
            
              <li>
                <a href="http://shenxiaobing.com/about">关于</a>
              </li>
            
          </ul>

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">理解KVO - 用Swift在WKWebView中添加进度条</h1>
      
      <div class="post-meta">
        <time datetime="2018-06-28" class="post-time">
          2018-06-28
        </time>
        <div class="post-category">
            <a href="http://shenxiaobing.com/categories/%E7%BC%96%E7%A8%8B/"> 编程 </a>
            
          </div>
        <span class="more-meta"> 约 2866 字 </span>
          <span class="more-meta"> 预计阅读 6 分钟 </span>

        
        

        
        
          <span id="/post/2019/understanding-kvo-in-swift/" class="leancloud_visitors" data-flag-title="理解KVO - 用Swift在WKWebView中添加进度条">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#添加观察者">添加观察者</a></li>
    <li><a href="#接收被观察者通知并响应处理">接收被观察者通知并响应处理</a></li>
    <li><a href="#移除观察者">移除观察者</a></li>
    <li><a href="#更swifty的实现方式block-based-kvo">更Swifty的实现方式：Block-based KVO</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>KVO，即Key-value observation，是苹果提供的一种机制，它可以使监听对象在被监听对象的数值发生改变时收到通知，进而去进行响应的处理。</p>
<p>KVO实现起来比较简单，主要的流程只有3个：</p>
<ol>
<li>添加观察者</li>
<li>在监听方法中处理监听结果</li>
<li>监听结束后移除观察者</li>
</ol>
<p>下面我们用一个实际的例子来说明一下这3个步骤。在App里使用<code>WKWebView</code>来加载网页时，我们希望实现一个在页面顶部的进度条，来表示网页加载的进度。而恰好<code>WKWebView</code>的实例有一个<code>estimatedProgress</code>属性，我们可以在此基础上使用KVO来实现。</p>
<h2 id="添加观察者">添加观察者</h2>
<p>第一步，是要正确地声明变量。因为KVO是在Objective-C中提供的，要在Swift中使用，被观察的属性必须添加<code>@objc</code>和<code>dynamic</code>关键词，来确保可以正确地被观察到。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">//</span><span class="c1"> </span><span class="c1">声</span><span class="c1">明</span><span class="c1">属</span><span class="c1">性</span><span class="c1">，</span><span class="c1">我</span><span class="c1">们</span><span class="c1">的</span><span class="c1">网</span><span class="c1">页</span><span class="c1">视</span><span class="c1">图</span>
<span class="kr">@objc</span> <span class="kd">var</span> <span class="nv">webview</span><span class="p">:</span> <span class="n">WKWebView</span><span class="p">!</span>

<span class="c1">//</span><span class="c1"> </span><span class="c1">创</span><span class="c1">建</span><span class="c1">私</span><span class="c1">有</span><span class="c1">变</span><span class="c1">量</span><span class="c1">，</span><span class="c1">用</span><span class="c1">于</span><span class="c1">添</span><span class="c1">加</span><span class="c1">观</span><span class="c1">察</span><span class="c1">者</span><span class="c1">时</span><span class="c1">创</span><span class="c1">建</span><span class="c1">c</span><span class="c1">o</span><span class="c1">n</span><span class="c1">t</span><span class="c1">e</span><span class="c1">x</span><span class="c1">t</span><span class="c1">参</span><span class="c1">数</span>
<span class="kd">private</span> <span class="kd">var</span> <span class="nv">progressContext</span> <span class="p">=</span> <span class="mi">0</span>
</code></pre></td></tr></table>
</div>
</div><p>第二步，就是在适合的位置添加观察者。一般来说在<code>viewDidLoad</code>中添加就可以。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">//</span><span class="c1"> </span><span class="c1">订</span><span class="c1">阅</span><span class="c1">观</span><span class="c1">察</span><span class="c1">w</span><span class="c1">e</span><span class="c1">b</span><span class="c1">V</span><span class="c1">i</span><span class="c1">e</span><span class="c1">w</span><span class="c1">.</span><span class="c1">e</span><span class="c1">s</span><span class="c1">t</span><span class="c1">i</span><span class="c1">m</span><span class="c1">a</span><span class="c1">t</span><span class="c1">e</span><span class="c1">d</span><span class="c1">P</span><span class="c1">r</span><span class="c1">o</span><span class="c1">g</span><span class="c1">r</span><span class="c1">e</span><span class="c1">s</span><span class="c1">s</span><span class="c1">属</span><span class="c1">性</span>
<span class="n">webView</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKeyPath</span><span class="p">:</span> <span class="p">#</span><span class="n">keyPath</span><span class="p">(</span><span class="n">estimatedProgress</span><span class="p">)</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">[</span><span class="p">.</span><span class="n">new</span><span class="p">,</span> <span class="p">.</span><span class="n">old</span><span class="p">]</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">progressContext</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>对于方法<code>func addObserver(_ observer: NSObject, forKeyPath keyPath: String, options: NSKeyValueObservingOptions = [], context: UnsafeMutableRawPointer?)</code>简单介绍下其参数：</p>
<ul>
<li>
<p>方法消息接受者，就是被监听的对象。不过就上面的代码而言，<code>webView</code>同样也是<code>self</code>当前controller的属性，所以这条消息也可以发送给<code>self</code>，但是<code>keyPath</code>就要相应地修改为<code>keyPath(webView.estimatedProgress)</code>。</p>
</li>
<li>
<p>观察者，即订阅观察的对象，在被观察者数值变化时收到通知。一般来说，就是当前的controller。</p>
</li>
<li>
<p>keyPath，即相对于接受者对象，需要观察的属性。可以直接用明确的字符串<code>&quot;estimatedProgress&quot;</code>来替代<code>#keyPath(estimatedProgress)</code>，但那样直接操作字符串出现打错，还是用#keyPath构造比较简单。</p>
</li>
<li>
<p>options，这里是接收对象时，选择接收的累类型。总共有4种，需要接受就添加其enum值进入数组参数传入：</p>
<ul>
<li><code>.new</code>，接收到变化后的新数值。</li>
<li><code>.old</code>，接收到变化前的老数值。</li>
<li><code>initial</code>，即要求立刻返回通知给观察者，在注册观察者方法返回之前。</li>
<li><code>.prior</code>，即是否需要在数值变化前和变化后各发送一条通知，而不是默认的只在变化后发送通知。</li>
</ul>
</li>
<li>
<p>context，这里的环境变量，一般用于在不同的观察者在观察相同的<code>keyPath</code>时用于区分。上面的添加观察者代码中，我其实没必要传入<code>context</code>，只是为了演示如何创建与传入<code>context</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">//</span><span class="c1"> </span><span class="c1">首</span><span class="c1">先</span><span class="c1">是</span><span class="c1">声</span><span class="c1">明</span><span class="c1">私</span><span class="c1">有</span><span class="c1">变</span><span class="c1">量</span>
<span class="kd">private</span> <span class="kd">var</span> <span class="nv">myContext</span> <span class="p">=</span> <span class="mi">0</span>
  
<span class="c1">//</span><span class="c1"> </span><span class="c1">然</span><span class="c1">后</span><span class="c1">直</span><span class="c1">接</span><span class="c1">使</span><span class="c1">用</span><span class="c1">`</span><span class="c1">&amp;</span><span class="c1">m</span><span class="c1">y</span><span class="c1">C</span><span class="c1">o</span><span class="c1">n</span><span class="c1">t</span><span class="c1">e</span><span class="c1">x</span><span class="c1">t</span><span class="c1">`</span><span class="c1">作</span><span class="c1">为</span><span class="c1">`</span><span class="c1">c</span><span class="c1">o</span><span class="c1">n</span><span class="c1">t</span><span class="c1">e</span><span class="c1">x</span><span class="c1">t</span><span class="c1">`</span><span class="c1">参</span><span class="c1">数</span><span class="c1">传</span><span class="c1">入</span><span class="c1">。</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="接收被观察者通知并响应处理">接收被观察者通知并响应处理</h2>
<p>我们的目的是实现进度条，因此需要先添加一条进度条。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">setUpWebView</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">webView</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">view</span><span class="p">.</span><span class="n">bounds</span>
    <span class="n">webView</span><span class="p">.</span><span class="n">navigationDelegate</span> <span class="p">=</span> <span class="kc">self</span>
    <span class="n">webView</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="p">=</span> <span class="p">[</span><span class="p">.</span><span class="n">flexibleWidth</span><span class="p">,</span> <span class="p">.</span><span class="n">flexibleHeight</span><span class="p">]</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="n">urlString</span><span class="p">!</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="s">url is nil</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">webView</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">URLRequest</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span><span class="p">)</span>

    <span class="c1">//</span><span class="c1"> </span><span class="c1">创</span><span class="c1">建</span><span class="c1">名</span><span class="c1">为</span><span class="c1">p</span><span class="c1">r</span><span class="c1">o</span><span class="c1">g</span><span class="c1">r</span><span class="c1">e</span><span class="c1">s</span><span class="c1">s</span><span class="c1">的</span><span class="c1">进</span><span class="c1">度</span><span class="c1">条</span>
    <span class="kd">let</span> <span class="nv">progress</span> <span class="p">=</span> <span class="n">UIView</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="n">webView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span><span class="p">)</span>
    <span class="n">webView</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="c1">//</span><span class="c1"> </span><span class="c1">之</span><span class="c1">前</span><span class="c1">已</span><span class="c1">经</span><span class="c1">提</span><span class="c1">前</span><span class="c1">声</span><span class="c1">明</span><span class="c1">了</span><span class="c1">p</span><span class="c1">r</span><span class="c1">o</span><span class="c1">g</span><span class="c1">r</span><span class="c1">e</span><span class="c1">s</span><span class="c1">s</span><span class="c1">L</span><span class="c1">a</span><span class="c1">y</span><span class="c1">e</span><span class="c1">r</span><span class="c1">作</span><span class="c1">为</span><span class="c1">实</span><span class="c1">例</span><span class="c1">变</span><span class="c1">量</span><span class="c1">，</span><span class="c1">方</span><span class="c1">便</span><span class="c1">作</span><span class="c1">为</span><span class="c1">进</span><span class="c1">度</span><span class="c1">条</span><span class="c1">修</span><span class="c1">改</span>
    <span class="n">progressLayer</span> <span class="p">=</span> <span class="n">CALayer</span><span class="p">(</span><span class="p">)</span>
    <span class="n">progressLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">APPColor</span><span class="p">.</span><span class="n">orange</span><span class="p">.</span><span class="n">cgColor</span>
    <span class="n">progress</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">progressLayer</span><span class="p">!</span><span class="p">)</span>

    <span class="n">view</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">webView</span><span class="p">)</span>
    
    <span class="c1">//</span><span class="c1"> </span><span class="c1">设</span><span class="c1">置</span><span class="c1">进</span><span class="c1">度</span><span class="c1">条</span><span class="c1">进</span><span class="c1">度</span><span class="c1">的</span><span class="c1">方</span><span class="c1">法</span><span class="c1">，</span><span class="c1">这</span><span class="c1">里</span><span class="c1">直</span><span class="c1">接</span><span class="c1">在</span><span class="c1">打</span><span class="c1">开</span><span class="c1">网</span><span class="c1">页</span><span class="c1">时</span><span class="c1">，</span><span class="c1">设</span><span class="c1">置</span><span class="c1">1</span><span class="c1">0</span><span class="c1">%</span><span class="c1">的</span><span class="c1">加</span><span class="c1">载</span><span class="c1">进</span><span class="c1">度</span><span class="c1">，</span><span class="c1">让</span><span class="c1">页</span><span class="c1">面</span><span class="c1">加</span><span class="c1">载</span><span class="c1">看</span><span class="c1">起</span><span class="c1">来</span><span class="c1">更</span><span class="c1">快</span>
    <span class="n">progressLayer</span><span class="p">!</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="n">webView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>进度条配置好了，下面就可以设置监听方法，来处理进度条了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kr">override</span> <span class="kd">func</span> <span class="nf">observeValue</span><span class="p">(</span><span class="n">forKeyPath</span> <span class="n">keyPath</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span><span class="p">,</span> <span class="n">of</span> <span class="n">object</span><span class="p">:</span> <span class="nb">Any</span><span class="p">?</span><span class="p">,</span> <span class="n">change</span><span class="p">:</span> <span class="p">[</span><span class="n">NSKeyValueChangeKey</span> <span class="p">:</span> <span class="nb">Any</span><span class="p">]</span><span class="p">?</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">?</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="n">keyPath</span> <span class="p">=</span><span class="p">=</span> <span class="p">#</span><span class="n">keyPath</span><span class="p">(</span><span class="n">webView</span><span class="p">.</span><span class="n">estimatedProgress</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">context</span> <span class="p">=</span><span class="p">=</span> <span class="p">&amp;</span><span class="n">progressContext</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">changes</span> <span class="p">=</span> <span class="n">change</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="c1">//</span><span class="c1">	</span><span class="c1">请</span><span class="c1">注</span><span class="c1">意</span><span class="c1">这</span><span class="c1">里</span><span class="c1">读</span><span class="c1">取</span><span class="c1">o</span><span class="c1">p</span><span class="c1">t</span><span class="c1">i</span><span class="c1">o</span><span class="c1">n</span><span class="c1">s</span><span class="c1">中</span><span class="c1">数</span><span class="c1">值</span><span class="c1">的</span><span class="c1">方</span><span class="c1">法</span>
    <span class="kd">let</span> <span class="nv">newValue</span> <span class="p">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">NSKeyValueChangeKey</span><span class="p">.</span><span class="n">newKey</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="nb">Double</span> <span class="p">?</span><span class="p">?</span> <span class="mi">0</span>
    <span class="kd">let</span> <span class="nv">oldValue</span> <span class="p">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">NSKeyValueChangeKey</span><span class="p">.</span><span class="n">oldKey</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="nb">Double</span> <span class="p">?</span><span class="p">?</span> <span class="mi">0</span>

    <span class="c1">//</span><span class="c1"> </span><span class="c1">因</span><span class="c1">为</span><span class="c1">我</span><span class="c1">们</span><span class="c1">已</span><span class="c1">经</span><span class="c1">设</span><span class="c1">置</span><span class="c1">了</span><span class="c1">进</span><span class="c1">度</span><span class="c1">条</span><span class="c1">为</span><span class="c1">0</span><span class="c1">.</span><span class="c1">1</span><span class="c1">，</span><span class="c1">所</span><span class="c1">以</span><span class="c1">只</span><span class="c1">有</span><span class="c1">在</span><span class="c1">进</span><span class="c1">度</span><span class="c1">大</span><span class="c1">于</span><span class="c1">0</span><span class="c1">.</span><span class="c1">1</span><span class="c1">后</span><span class="c1">再</span><span class="c1">进</span><span class="c1">行</span><span class="c1">变</span><span class="c1">化</span>
    <span class="k">if</span> <span class="n">newValue</span> <span class="o">&gt;</span> <span class="n">oldValue</span> <span class="o">&amp;&amp;</span> <span class="n">newValue</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="p">{</span>
        <span class="n">progressLayer</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="n">webView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">//</span><span class="c1"> </span><span class="c1">当</span><span class="c1">进</span><span class="c1">度</span><span class="c1">为</span><span class="c1">1</span><span class="c1">0</span><span class="c1">0</span><span class="c1">%</span><span class="c1">时</span><span class="c1">，</span><span class="c1">隐</span><span class="c1">藏</span><span class="c1">p</span><span class="c1">r</span><span class="c1">o</span><span class="c1">g</span><span class="c1">r</span><span class="c1">e</span><span class="c1">s</span><span class="c1">s</span><span class="c1">L</span><span class="c1">a</span><span class="c1">y</span><span class="c1">e</span><span class="c1">r</span><span class="c1">并</span><span class="c1">将</span><span class="c1">其</span><span class="c1">初</span><span class="c1">始</span><span class="c1">值</span><span class="c1">改</span><span class="c1">为</span><span class="c1">0</span>
    <span class="k">if</span> <span class="n">newValue</span> <span class="p">=</span><span class="p">=</span> <span class="mf">1.0</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">time1</span> <span class="p">=</span> <span class="n">DispatchTime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.4</span>
        <span class="kd">let</span> <span class="nv">time2</span> <span class="p">=</span> <span class="n">time1</span> <span class="o">+</span> <span class="mf">0.1</span>
        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="n">time1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">weakself</span> <span class="p">=</span> <span class="kc">self</span>
            <span class="n">weakself</span><span class="p">?</span><span class="p">.</span><span class="n">progressLayer</span><span class="p">.</span><span class="n">opacity</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="n">time2</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">weakself</span> <span class="p">=</span> <span class="kc">self</span>
            <span class="n">weakself</span><span class="p">?</span><span class="p">.</span><span class="n">progressLayer</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> 
</code></pre></td></tr></table>
</div>
</div><h2 id="移除观察者">移除观察者</h2>
<p>在不需要监听时，或者至少在<code>观察者</code>要被释放之前，需要移除观察者身份。</p>
<p>在<code>viewDidDisappear</code>或者其他适当的位置，调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">removeObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKeyPath</span><span class="p">:</span> <span class="p">#</span><span class="n">keyPath</span><span class="p">(</span><span class="n">webView</span><span class="p">.</span><span class="n">estimatedProgress</span><span class="p">)</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这样利用KVO实现加载进度条的目的已经达成了。</p>
<h2 id="更swifty的实现方式block-based-kvo">更Swifty的实现方式：Block-based KVO</h2>
<p>在Swift4里，官方推荐了另外Key-value Oberservation的实现方式。简单来说，就是创建一个变量observation、给obervation赋值。赋值实现了既添加观察者又实现响应通知的功能。最后在不需要观察时，直接把observation设置为<code>nil</code>即可。</p>
<p>针对上面的进度加载条，实现代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">//</span><span class="c1"> </span><span class="c1">声</span><span class="c1">明</span><span class="c1">变</span><span class="c1">量</span><span class="c1">，</span><span class="c1">被</span><span class="c1">观</span><span class="c1">察</span><span class="c1">的</span><span class="c1">属</span><span class="c1">性</span><span class="c1">依</span><span class="c1">然</span><span class="c1">还</span><span class="c1">需</span><span class="c1">要</span><span class="c1">添</span><span class="c1">加</span><span class="c1">@</span><span class="c1">o</span><span class="c1">b</span><span class="c1">j</span><span class="c1">c</span><span class="c1">和</span><span class="c1">d</span><span class="c1">y</span><span class="c1">n</span><span class="c1">a</span><span class="c1">m</span><span class="c1">i</span><span class="c1">c</span>
<span class="kr">@objc</span> <span class="kd">var</span> <span class="nv">webView</span> <span class="p">=</span> <span class="n">WKWebView</span><span class="p">(</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">progressLayer</span><span class="p">:</span> <span class="n">CALayer</span><span class="p">!</span>
<span class="kd">var</span> <span class="nv">progressObervation</span><span class="p">:</span> <span class="n">NSKeyValueObservation</span><span class="p">?</span>

<span class="c1">//</span><span class="c1"> </span><span class="c1">设</span><span class="c1">置</span><span class="c1">观</span><span class="c1">察</span>
<span class="kd">func</span> <span class="nf">setupObserver</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//</span><span class="c1"> </span><span class="c1">请</span><span class="c1">务</span><span class="c1">必</span><span class="c1">注</span><span class="c1">意</span><span class="c1">方</span><span class="c1">法</span><span class="c1">的</span><span class="c1">写</span><span class="c1">法</span>
    <span class="n">progressObservation</span> <span class="p">=</span> <span class="n">observe</span><span class="p">(</span><span class="err">\</span><span class="p">.</span><span class="n">webView</span><span class="p">.</span><span class="n">estimatedProgress</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">[</span><span class="p">.</span><span class="n">old</span><span class="p">,</span> <span class="p">.</span><span class="n">new</span><span class="p">]</span><span class="p">,</span> <span class="n">changeHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span> <span class="k">in</span>
        <span class="kd">let</span> <span class="nv">newValue</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">newValue</span>  <span class="p">?</span><span class="p">?</span> <span class="mi">0</span>
        <span class="kd">let</span> <span class="nv">oldValue</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">oldValue</span>  <span class="p">?</span><span class="p">?</span> <span class="mi">0</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="s">new value is </span><span class="si">\(</span><span class="n">newValue</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="s">new value is </span><span class="si">\(</span><span class="n">oldValue</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newValue</span> <span class="o">&gt;</span> <span class="n">oldValue</span> <span class="o">&amp;&amp;</span> <span class="n">newValue</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="s">time to reset new value</span><span class="s">&#34;</span><span class="p">)</span>
            <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">weakself</span> <span class="p">=</span> <span class="kc">self</span>
            <span class="n">weakself</span><span class="p">?</span><span class="p">.</span><span class="n">progressLayer</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="p">(</span><span class="n">weakself</span><span class="p">?</span><span class="p">.</span><span class="n">webView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="o">!</span> <span class="o">*</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">newValue</span> <span class="p">=</span><span class="p">=</span> <span class="mf">1.0</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">time1</span> <span class="p">=</span> <span class="n">DispatchTime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.4</span>
            <span class="kd">let</span> <span class="nv">time2</span> <span class="p">=</span> <span class="n">time1</span> <span class="o">+</span> <span class="mf">0.1</span>
            <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="n">time1</span><span class="p">)</span> <span class="p">{</span>
                <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">weakself</span> <span class="p">=</span> <span class="kc">self</span>
                <span class="n">weakself</span><span class="p">?</span><span class="p">.</span><span class="n">progressLayer</span><span class="p">.</span><span class="n">opacity</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="p">}</span>

            <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="n">time2</span><span class="p">)</span> <span class="p">{</span>
                <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">weakself</span> <span class="p">=</span> <span class="kc">self</span>
                <span class="n">weakself</span><span class="p">?</span><span class="p">.</span><span class="n">progressLayer</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">destroyObserver</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">progressObservation</span> <span class="p">=</span> <span class="kc">nil</span>
    
    <span class="n">progressObserver</span><span class="p">?</span><span class="p">.</span><span class="n">invalidate</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这样看来是不是很简单？而且一个NSKeyValueObservation对象只负责观察一个<code>keyPath</code>，非常清晰。同时只用一行代码和闭包，更简洁。</p>
<p>这里介绍下给observation赋值的方法参数。</p>
<ul>
<li>
<p>receiver，即方法的接受者。上面的方法可以改成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">progressObserver</span> <span class="p">=</span> <span class="n">webView</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="err">\</span><span class="p">.</span><span class="n">estimatedProgress</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">[</span><span class="p">.</span><span class="n">old</span><span class="p">,</span> <span class="p">.</span><span class="n">new</span><span class="p">]</span><span class="p">,</span> <span class="n">changeHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">webView</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//</span><span class="c1"> </span><span class="c1">c</span><span class="c1">o</span><span class="c1">d</span><span class="c1">e</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>keyPath，这里的<code>keyPath</code>与上文中的<code>keyPath</code>接收的参数类型不同。这里是<code>KeyPath</code>类型，而上面<code>addObserver</code>方法中的<code>keyPath</code>是字符串。写法是<code>\.property</code>，这里的<code>property</code>是相对于<code>receiver</code>的，所以当<code>receiver</code>是controller时，<code>keyPath</code>就是<code>\.webView.estimatedProgress</code>；而当<code>receiver</code>是<code>webView</code>时，keyPath则是<code>\.estimatedProgress</code>。</p>
</li>
<li>
<p>options，与上文一样，传入可选的<code>.new, .old, .initial, .prior</code>。可不传入options，这样的话，不能从闭包中接收到的<code>change</code>里的<code>newValue</code>和<code>oldValue</code>都是0。</p>
</li>
<li>
<p>closure，闭包接收2个参数，即<code>receiver</code>和作为<code>NSKeyValueObservedChange</code>类型的<code>change</code>。从change可以读取其<code>newValue</code>和<code>oldValue</code>。</p>
</li>
</ul>
<p>最后关于停止监听，有两个办法可选：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">//</span><span class="c1"> </span><span class="c1">销</span><span class="c1">毁</span>
<span class="n">progressObserver</span> <span class="p">=</span> <span class="kc">nil</span>

<span class="c1">//</span><span class="c1"> </span><span class="c1">不</span><span class="c1">销</span><span class="c1">毁</span><span class="c1">，</span><span class="c1">仅</span><span class="c1">仅</span><span class="c1">停</span><span class="c1">止</span><span class="c1">监</span><span class="c1">听</span>
<span class="n">progressObserver</span><span class="p">?</span><span class="p">.</span><span class="n">invalidate</span><span class="p">(</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如果不需要停止，可以不用处理，也不用刻意去移除监听，<code>controller</code>作为<code>observation</code>的<code>owner</code>会自动处理。</p>
<blockquote>
<p>本人初学，有错误或疏漏之处，欢迎斧正！</p>
</blockquote>
<p>参考文档：</p>
<ul>
<li><a href="http://swifter.tips/kvo/">http://swifter.tips/kvo/</a></li>
<li><a href="https://cocoacasts.com/key-value-observing-kvo-and-swift-3">https://cocoacasts.com/key-value-observing-kvo-and-swift-3</a></li>
<li><a href="https://www.jianshu.com/p/24b3e3ddc946">https://www.jianshu.com/p/24b3e3ddc946</a></li>
<li><a href="https://developer.apple.com/documentation/swift/cocoa_design_patterns/using_key_value_observing_in_swift">Using Key-Value Observing in Swift | Apple Developer Documentation</a></li>
<li><a href="https://nshipster.com/key-value-observing/">https://nshipster.com/key-value-observing/</a></li>
</ul>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Shen Xiaobing</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2018-06-28
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechatpay.png">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/alipay.png">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://shenxiaobing.com/tags/kvo/">KVO</a>
          <a href="http://shenxiaobing.com/tags/swift/">Swift</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2019/progress-bar-like-wechat-webview/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">仿照微信WebView实现ProgressBar</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/2019/swift-iap-pitfalls/">
            <span class="next-text nav-default">苹果内购接入的坑与核心流程 - Swift</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "http://shenxiaobing.com/post/2019/understanding-kvo-in-swift/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'shenxiaobing';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:xiaobing.shen@foxmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>


<a href="http://shenxiaobing.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Shen Xiaobing
        
      </span></span>

  
  

  
    <span>
      <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备19049773号-1</a>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?7390efd508bf472b486211e3538692d9";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  







  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("5nxAXNGRN9qW7YzsbrSTQIqi-gzGzoHsz", "cw5bUfHdfqCiITOe0fguV11D");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>









</body>
</html>
